<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive 3D Water Resource Map of India</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    <style>
    :root{
        --bg:#f8f9fb;
        --panel:#ffffff;
        --muted:#8b93a7;
        --accent:#6a4ce8;
    }
    *{box-sizing:border-box;}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;color:#222;}
    body{background:var(--bg);}
    .app{
        width:98vw; height:96vh; margin:1vw auto; border-radius:30px; overflow:hidden;
        box-shadow:0 12px 40px rgba(0,0,0,0.1); background:var(--panel); display:flex;
        flex-direction:column; position:relative; animation: fadeInApp 1.1s cubic-bezier(.77,0,.18,1) both;
    }
    @keyframes fadeInApp {
        from { opacity: 0; transform: translateY(40px) scale(0.98);}
        to { opacity: 1; transform: translateY(0) scale(1);}
    }
    .topbar{
        display:flex; align-items:center; gap:14px; padding:18px 28px; background:linear-gradient(135deg,#222028,#2c2c2c);
        border-radius:18px; margin:14px 14px 0 14px; box-shadow:0 8px 30px rgba(30,30,60,0.12); z-index:10; position:relative;
    }
    .logo-avatar{
        width:48px; height:48px; border-radius:10px; background:linear-gradient(135deg,var(--accent),#8b6ff2); display:flex;
        align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:18px;
    }
    .site-title{ font-weight:700; color:#ffffff; font-size:22px; font-family:'Segoe UI',sans-serif; }
    #map {
        flex:1; min-height:400px; border-radius:24px; margin:18px 24px 24px 24px;
        box-shadow:0 6px 18px rgba(35,30,60,0.06); position:relative; z-index:1;
    }

    /* --- MODIFIED: Legend Panel & Info Panel Positioning and Animation --- */
    .legend-panel {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 8;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 15px;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: opacity 0.4s, visibility 0.4s;
    }

    .info-panel {
        background:var(--panel);
        border-radius:20px 20px 0 0;
        box-shadow:0 -10px 40px rgba(35,30,60,0.1);
        z-index: 10;
        position:absolute;
        left: 50%;
        bottom: 0;
        width: 600px;
        max-width: 95%;
        
        /* Hidden state */
        transform: translate(-50%, 100%);
        visibility: hidden;
        
        transition: transform 0.6s cubic-bezier(0.165, 0.84, 0.44, 1);
        border-top: 4px solid #ccc;
    }

    /* Visible state for panels */
    .info-panel.visible {
        transform: translate(-50%, 0);
        visibility: visible;
    }
    .legend-panel.hidden {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
    }

    /* Panel Content Styles */
    #info-header {
        padding: 18px 22px;
        border-bottom: 1px solid #f0f0f0;
        position: relative;
    }
    #info-title { font-size:20px; font-weight:700; color:#222; margin-bottom: 4px; }
    #info-status { font-size: 14px; font-weight: 600; }
    #info-content { padding: 20px 22px; display: flex; flex-direction: column; gap: 18px; }
    .info-stat-label { font-size: 14px; color: #666; }
    .info-stat-bar-background { width: 100%; height: 10px; background-color: #e9ecef; border-radius: 5px; overflow: hidden; }
    .info-stat-bar-fill { height: 100%; border-radius: 5px; transition: width 0.8s cubic-bezier(.77,0,.18,1); }
    .info-data-row { display: flex; justify-content: space-between; align-items: center; }
    .info-data-value { font-weight: 600; font-size: 16px; color: #333; }
    
    /* Close Button */
    .close-btn {
        position: absolute;
        top: 12px;
        right: 15px;
        font-size: 28px;
        font-weight: 300;
        color: #888;
        background: none;
        border: none;
        cursor: pointer;
        line-height: 1;
        padding: 5px;
    }
    .close-btn:hover { color: #222; }

    .legend-title{ font-size:16px; font-weight:600; color:#333; }
    .legend-row{ display:flex; align-items:center; gap: 8px; font-size:14px; }
    .legend-dot{ width:16px; height:16px; border-radius:50%; border:1.5px solid rgba(0,0,0,0.05); }
    .dot-safe{background:#91cf60;} .dot-semicritical{background:#fee08b;} .dot-critical{background:#fc8d59;} .dot-over{background:#d73027;}
    
    /* Updated styles for the back button on the header */
    .back-btn{
        background:none; color:#fff; border:none; padding:8px 18px; border-radius:12px; font-weight:600; cursor:pointer;
        box-shadow:none; margin-left:auto; margin-top:0; margin-bottom:0; align-self:center;
        z-index:20; position:relative; transition:background 0.2s, transform 0.2s;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3); /* Optional: Adds a subtle shadow for better readability on dark background */
    }
    .back-btn:hover {
        background: rgba(255,255,255,0.1);
        transform: scale(1.05);
    }

    #loader {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 8px solid #f3f3f3;
        border-top: 8px solid #3498db; border-radius: 50%; width: 60px; height: 60px;
        animation: spin 2s linear infinite; z-index: 1000;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
<div class="app">
    <div class="topbar">
        <div class="logo-avatar">IG</div>
        <div>
            <div class="site-title">India's Groundwater Status</div>
        </div>
        <button class="back-btn" onclick="location.href='index.html'">‚Üê Back to Home</button>
    </div>

    <div class="legend-panel" id="legend-panel">
        <div class="legend-title">Extraction:</div>
        <div class="legend-row"><span class="legend-dot dot-safe"></span>Safe</div>
        <div class="legend-row"><span class="legend-dot dot-semicritical"></span>Semi-Critical</div>
        <div class="legend-row"><span class="legend-dot dot-critical"></span>Critical</div>
        <div class="legend-row"><span class="legend-dot dot-over"></span>Over-Exploited</div>
    </div>

    <div class="info-panel" id="info-panel">
        <div id="info-header">
            <button id="close-btn" class="close-btn">&times;</button>
            <div id="info-title"></div>
            <div id="info-status"></div>
        </div>
        <div id="info-content"></div>
    </div>

    <div id="loader"></div>
    <div id="map"></div>
</div>
<script>
    const maptilerApiKey = 'RhLuvXAqVQNBycZk61r5'; 
    if (!maptilerApiKey) throw new Error("Maptiler API key is missing.");

    const groundwaterData = { "Andhra Pradesh": { "category": "Safe", "stage_of_extraction_percent": 29.83, "recharge": 27.80, "extraction": 7.88 }, "Arunachal Pradesh": { "category": "Safe", "stage_of_extraction_percent": 0.39, "recharge": 3.88, "extraction": 0.01 }, "Assam": { "category": "Safe", "stage_of_extraction_percent": 12.61, "recharge": 27.21, "extraction": 2.64 }, "Bihar": { "category": "Safe", "stage_of_extraction_percent": 45.54, "recharge": 34.15, "extraction": 14.10 }, "Chhattisgarh": { "category": "Safe", "stage_of_extraction_percent": 47.32, "recharge": 14.18, "extraction": 6.12 }, "Goa": { "category": "Safe", "stage_of_extraction_percent": 22.91, "recharge": 0.38, "extraction": 0.07 }, "Gujarat": { "category": "Safe", "stage_of_extraction_percent": 54.21, "recharge": 27.58, "extraction": 13.86 }, "Haryana": { "category": "Over-Exploited", "stage_of_extraction_percent": 135.96, "recharge": 10.32, "extraction": 12.72 }, "Himachal Pradesh": { "category": "Safe", "stage_of_extraction_percent": 35.48, "recharge": 1.11, "extraction": 0.36 }, "Jharkhand": { "category": "Safe", "stage_of_extraction_percent": 31.43, "recharge": 6.28, "extraction": 1.81 }, "Karnataka": { "category": "Safe", "stage_of_extraction_percent": 68.44, "recharge": 18.74, "extraction": 11.55 }, "Kerala": { "category": "Safe", "stage_of_extraction_percent": 53.78, "recharge": 5.67, "extraction": 2.76 }, "Madhya Pradesh": { "category": "Safe", "stage_of_extraction_percent": 58.40, "recharge": 35.90, "extraction": 19.85 }, "Maharashtra": { "category": "Safe", "stage_of_extraction_percent": 52.99, "recharge": 33.03, "extraction": 16.50 }, "Manipur": { "category": "Safe", "stage_of_extraction_percent": 8.00, "recharge": 0.52, "extraction": 0.04 }, "Meghalaya": { "category": "Safe", "stage_of_extraction_percent": 4.60, "recharge": 1.86, "extraction": 0.07 }, "Mizoram": { "category": "Safe", "stage_of_extraction_percent": 3.95, "recharge": 0.21, "extraction": 0.01 }, "Nagaland": { "category": "Safe", "stage_of_extraction_percent": 4.72, "recharge": 0.62, "extraction": 0.03 }, "Odisha": { "category": "Safe", "stage_of_extraction_percent": 48.23, "recharge": 17.46, "extraction": 7.74 }, "Punjab": { "category": "Over-Exploited", "stage_of_extraction_percent": 156.87, "recharge": 19.19, "extraction": 27.66 }, "Rajasthan": { "category": "Over-Exploited", "stage_of_extraction_percent": 149.86, "recharge": 12.58, "extraction": 17.05 }, "Sikkim": { "category": "Safe", "stage_of_extraction_percent": 5.85, "recharge": 0.24, "extraction": 0.01 }, "Tamil Nadu": { "category": "Semi-Critical", "stage_of_extraction_percent": 74.26, "recharge": 21.51, "extraction": 14.45 }, "Telangana": { "category": "Safe", "stage_of_extraction_percent": 45.91, "recharge": 20.40, "extraction": 8.47 }, "Tripura": { "category": "Safe", "stage_of_extraction_percent": 9.48, "recharge": 1.45, "extraction": 0.11 }, "Uttar Pradesh": { "category": "Semi-Critical", "stage_of_extraction_percent": 70.45, "recharge": 72.84, "extraction": 46.76 }, "Uttarakhand": { "category": "Safe", "stage_of_extraction_percent": 53.54, "recharge": 2.14, "extraction": 1.05 }, "West Bengal": { "category": "Safe", "stage_of_extraction_percent": 45.63, "recharge": 25.89, "extraction": 10.75 }, "Andaman and Nicobar Islands": { "category": "Safe", "stage_of_extraction_percent": 2.08, "recharge": 0.38, "extraction": 0.01 }, "Chandigarh": { "category": "Safe", "stage_of_extraction_percent": 66.13, "recharge": 0.06, "extraction": 0.03 }, "Dadra and Nagar Haveli and Daman and Diu": { "category": "Over-Exploited", "stage_of_extraction_percent": 142.17, "recharge": 0.12, "extraction": 0.16 }, "Delhi": { "category": "Over-Exploited", "stage_of_extraction_percent": 100.77, "recharge": 0.38, "extraction": 0.34 }, "Jammu and Kashmir": { "category": "Safe", "stage_of_extraction_percent": 22.28, "recharge": 2.55, "extraction": 0.51 }, "Ladakh": { "category": "Safe", "stage_of_extraction_percent": 30.93, "recharge": 0.07, "extraction": 0.02 }, "Lakshadweep": { "category": "Safe", "stage_of_extraction_percent": 61.32, "recharge": 0.01, "extraction": 0.003 }, "Puducherry": { "category": "Semi-Critical", "stage_of_extraction_percent": 75.91, "recharge": 0.19, "extraction": 0.13 } };
    const geojsonDataUrl = 'https://raw.githubusercontent.com/geohacker/india/master/state/india_state.geojson';
    const map = new maplibregl.Map({
        container: 'map', style: `https://api.maptiler.com/maps/streets/style.json?key=${maptilerApiKey}`, center: [82.8, 23.5], zoom: 4.2, pitch: 0, bearing: 0, antialias: true
    });

    map.addControl(new maplibregl.NavigationControl());

    map.on('load', async () => {
        try {
            const response = await fetch(geojsonDataUrl);
            const geojsonData = await response.json();
            geojsonData.features.forEach(feature => {
                const stateName = feature.properties.NAME_1;
                const data = groundwaterData[stateName];
                if (data) Object.assign(feature.properties, data);
            });

            map.addSource('states', {'type': 'geojson', 'data': geojsonData});
            map.addLayer({
                'id': 'state-extrusion', 'type': 'fill-extrusion', 'source': 'states',
                'paint': {
                    'fill-extrusion-color': ['case', ['==', ['get', 'category'], 'Over-Exploited'], '#d73027', ['==', ['get', 'category'], 'Critical'], '#fc8d59', ['==', ['get', 'category'], 'Semi-Critical'], '#fee08b', ['==', ['get', 'category'], 'Safe'], '#91cf60', '#ccc'],
                    'fill-extrusion-height': ['interpolate', ['linear'], ['get', 'stage_of_extraction_percent'], 0, 0, 160, 200000],
                    'fill-extrusion-base': 0, 'fill-extrusion-opacity': 0.85
                }
            });

            // --- MODIFIED: Get panel elements ---
            const infoPanel = document.getElementById('info-panel');
            const legendPanel = document.getElementById('legend-panel');
            const infoTitle = document.getElementById('info-title');
            const infoStatus = document.getElementById('info-status');
            const infoContent = document.getElementById('info-content');
            
            map.on('click', 'state-extrusion', (e) => {
                const props = e.features[0].properties;
                const statusColor = getColor(props.category);
                
                infoPanel.style.borderColor = statusColor;
                infoTitle.textContent = props.NAME_1;
                infoStatus.textContent = props.category;
                infoStatus.style.color = statusColor;

                const barWidth = Math.min(props.stage_of_extraction_percent, 100);
                infoContent.innerHTML = `
                    <div>
                        <div class="info-stat-label">Stage of Extraction: <strong>${props.stage_of_extraction_percent}%</strong></div>
                        <div class="info-stat-bar-background">
                            <div class="info-stat-bar-fill" style="width: 0%; background-color: ${statusColor};"></div>
                        </div>
                    </div>
                    <div class="info-data-row">
                        <span class="info-stat-label">Annual Recharge</span>
                        <span class="info-data-value">${props.recharge} BCM</span>
                    </div>
                    <div class="info-data-row">
                        <span class="info-stat-label">Annual Extraction</span>
                        <span class="info-data-value">${props.extraction} BCM</span>
                    </div>
                `;
                
                // --- NEW: Show info panel and hide legend ---
                infoPanel.classList.add('visible');
                legendPanel.classList.add('hidden');

                setTimeout(() => {
                    const barFill = infoContent.querySelector('.info-stat-bar-fill');
                    if(barFill) barFill.style.width = `${barWidth}%`;
                }, 300); // Delay for slide-in animation
            });

            // --- NEW: Close button event listener ---
            document.getElementById('close-btn').addEventListener('click', () => {
                infoPanel.classList.remove('visible');
                legendPanel.classList.remove('hidden');
            });

            map.on('mouseenter', 'state-extrusion', () => { map.getCanvas().style.cursor = 'pointer'; });
            map.on('mouseleave', 'state-extrusion', () => { map.getCanvas().style.cursor = ''; });

            document.getElementById('loader').style.display = 'none';

        } catch (error) { console.error("Failed to load map data:", error); }
    });

    function getColor(category) {
        switch (category) {
            case 'Over-Exploited': return '#d73027';
            case 'Critical': return '#fc8d59';
            case 'Semi-Critical': return '#fee08b';
            case 'Safe': return '#91cf60';
            default: return '#ccc';
        }
    }
</script>
</body>
</html>
